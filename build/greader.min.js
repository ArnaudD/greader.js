/*! greader.js 2013-03-05 */
(function(){var e,t="https://www.google.com/accounts/ClientLogin",r="http://www.google.com/reader/api/0/",n="preference/stream/list",o="stream/contents/",s="subscription/",i="tag/",a="list",u="edit",c="mark-all-as-read",d="token",l="user-info",f="unread-count",p="rename-tag",m="edit-tag",h="";if(e={CLIENT:"greader.js",TAGS:{like:"user/-/state/com.google/like",label:"user/-/label/",star:"user/-/state/com.google/starred",read:"user/-/state/com.google/read",fresh:"user/-/state/com.google/fresh",share:"user/-/state/com.google/broadcast","kept-unread":"user/-/state/com.google/kept-unread","reading-list":"user/-/state/com.google/reading-list"},init:function(e){this._ready&&this._init(),this._readyCallback=e},_onStoreReady:function(){this._ready=!0,this._init()},_init:function(){this._readyCallback&&this._readyCallback.call(this)}},"undefined"!=typeof exports){if("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.greader=e,!g){var g=require("underscore");g.string=require("underscore.string")}if(!T)var T=require("xhr2");if(!v)var v=require("async")}else this.greader=e;g.mixin(g.string.exports()),g.string.include("Underscore.string","string"),e.MemoryStore=function(){var e={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:function(e){throw e},indexes:[]},t=function(t,r){for(var n in e)this[n]=t[n]!==void 0?t[n]:e[n];this.store={},r?r():this.onStoreReady(),this._insertIdCount=0};t.prototype={deleteDatabase:function(){delete this.store},put:function(e,t){t||(t=r),e[this.keyPath]===void 0&&(e[this.keyPath]=this._getUID()),this.store[this.keyPath]=e,t(e)},get:function(e,t){t||(t=r),t(this.store[e])},remove:function(e,t){t||(t=r),delete this.store[e],t()},batch:function(e,t,n){"[object Array]"!=Object.prototype.toString.call(e)&&n(Error("dataArray argument must be of type Array.")),t||(t=r);var o=e.length,s=!1,i=function(){o--,0!==o||s||(s=!0,t())};g.each(e,function(e){var t=e.type,r=e.key,n=e.value;"remove"===t?this.remove(r,i):"put"===t&&this.put(n,i)},this)},getAll:function(e){e(g.values(this.store))},clear:function(e){e||(e=r),this.store={},e()},_getUID:function(){return this._insertIdCount++ +Date.now()},getIndexList:function(){return this.store.indexNames}};var r=function(){};return t}(this),function(t){var r,n,o=0;r=t.indexedDB||t.webkitIndexedDB||t.mozIndexedDB?IDBStore:e.MemoryStore,n=function(){o++,3===o&&e.onready&&e.onStoreReady()},e.stores={user:new r({dbVersion:1,storeName:"user",keyPath:"name",autoIncrement:!1,onStoreReady:n}),feeds:new r({dbVersion:1,storeName:"feeds",onStoreReady:n}),items:new r({dbVersion:1,storeName:"items",onStoreReady:n})}}(this);var S=[],b=function(e){var t,r=[];for(t in e)e.hasOwnProperty(t)&&("set"===t?g.each(e[t],function(e){b(e)}):r.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t])));return r.join("&")},I=function(t,r){4===this.readyState&&200===this.status?r.onSuccess&&(r.onSuccess(this),S[t]&&delete S[t]):4===this.readyState&&("POST"===r.method?r.tried||e.user.getToken(function(){r.tried=!0,y(r),S[t]&&delete S[t]},r.onFailure):r.onFailure&&(r.onFailure(this),S[t]&&delete S[t]),401===this.status&&"Unauthorized"===this.statusText&&console.error("AUTH EXPIRED? TRY LOGGING IN AGAIN"),console.error("Request Failed: "+this))},y=function(t,r){var n,o,s,i;t.method=t.method||"GET",t.parameters=t.parameters||{},"GET"===t.method&&(t.parameters.ck=Date.now()||(new Date).getTime(),t.parameters.accountType="GOOGLE",t.parameters.service="reader",t.parameters.output="json",t.parameters.client=e.CLIENT),h&&"POST"===t.method&&(t.parameters.T=h),s=b(t.parameters),n=t.url+"?",n+="GET"===t.method?s:"client="+encodeURIComponent(CLIENT),console.log("> url"+n),o=new T,o.open(t.method,n,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Cookie",""),i=e.user.getAuth(),i&&!r&&o.setRequestHeader("Authorization","GoogleLogin auth="+i),o.onreadystatechange=g.bind(I,o,S.length,t),o.send("POST"===t.method?s:""),S.push(o)};e.user=function(){var o,s=e.stores.user,i=e.stores.feeds,a=null;return o={isAuth:function(){return null!==a},getAuth:function(){return a},login:function(r,n,i,u){return 0===r.length||0===n.length?(u("Blank Info..."),void 0):(y({method:"GET",url:t,parameters:{Email:r,Passwd:n},onSuccess:function(e){a=g.lines(e.responseText)[2].replace("Auth=",""),s.put({name:"auth",value:a},function(){o.load(i,u)})},onFailure:function(t){console.error(t),u(e.normalizeError(t.responseText))}}),void 0)},logout:function(){s.clear(),i.clear()},getToken:function(t,n){y({method:"GET",url:r+d,parameters:{},onSuccess:function(e){console.log(e),h=e.responseText,t()},onFailure:function(t){console.error("failed",t),n&&n(e.normalizeError(t.responseText))}})},load:function(t,n){y({method:"GET",url:r+l,parameters:{},onSuccess:function(e){var r=JSON.parse(e.responseText);s.put({name:"info",value:r},function(){t(r)})},onFailure:function(t){console.error(t),n&&n(e.normalizeError(t.responseText))}})},loadPreferences:function(t,i){y({method:"GET",url:r+n,parameters:{},onSuccess:function(e){o.preferencesLoaded=!0,o.preferences=JSON.parse(e.responseText).streamprefs,s.put({name:"preferences",value:this.preferences}),t&&t()},onFailure:function(t){console.error(t),i&&i(e.normalizeError(t.responseText))}})},get:function(e,t){s.get("info",e,t)}}}();var x,w,A=function(e,t,n){return e?(y({method:"POST",url:r+s+u,parameters:e,onSuccess:function(e){t(e.responseText)},onFailure:function(e){console.error(e),n&&n(e)}}),void 0):(console.error("No params for feed edit"),void 0)};x={set:function(e){readerFeeds=e},get:function(){return readerFeeds},load:function(t){return e.user.preferencesLoaded?(v.parallel({subscriptions:function(e){y({method:"GET",url:r+s+a,onSuccess:function(t){e(null,JSON.parse(t.responseText).subscriptions)},onFailure:function(t){e("error loading feeds",t)}})},labels:function(e){w.load(function(t){e(null,t)})},unreadcounts:function(e){x.getUnreadCounts(function(t){e(null,t)})}},function(r,n){if(r)return console.error(r),void 0;var o=x.organize(n.subscriptions,n.labels,n.unreadcounts,e.user.preferences);x.set(o),t(o)}),void 0):e.user.loadPreferences(g.bind(x.load,this,t))},organize:function(t,r,n,o){var s=[],i=g(r).reject(function(t){return"user/-/state/com.google/broadcast"===e.correctId(t.id)||"user/-/state/com.blogger/blogger-following"===e.correctId(t.id)});i.unshift({title:"All",id:e.TAGS["reading-list"],feeds:t,isAll:!0,isSpecial:!0});var a=/[^\/]+$/i;g(i).each(function(t){t.title=t.title||a.exec(t.id)[0],"starred"===t.title?(t.title=g(t.title).capitalize(),t.isSpecial=!0):t.isSpecial||(t.isLabel=!0),t.feeds=[],t.id=e.correctId(t.id),g(n).each(function(r){r.id=e.correctId(r.id),t.id===r.id&&(t.count=r.count,t.newestItemTimestamp=r.newestItemTimestampUsec)})}),g(t).each(function(t){t.isFeed=!0,t.id=e.correctId(t.id),g(n).each(function(e){t.id===e.id&&(t.count=e.count,t.newestItemTimestamp=e.newestItemTimestampUsec)}),0===t.categories.length?s.push(t):g(t.categories).each(function(r){r.id=e.correctId(r.id),g(i).each(function(e){if(r.id===e.id){var n=g(t).clone();n.inside=e.id,e.feeds.push(n)}})})}),g(o).each(function(t,r){/user\/\d*\//.test(r)&&(o[e.correctId(r)]=t)});var u=g(i).reject(function(e){return 0===e.feeds.length&&!e.isSpecial});g(u).each(function(e){var t=g(o[e.id]).detect(function(e){return"subscription-ordering"===e.id});t&&(e.feeds=g(e.feeds).sortBy(function(e){return-1===t.value.indexOf(e.sortid)?1e3:t.value.indexOf(e.sortid)/8}))});var c=g(o["user/-/state/com.google/root"]).detect(function(e){return"subscription-ordering"===e.id})||{value:""},d=[].concat(u,s);return d=g(d).sortBy(function(e){return-1!==c.value.indexOf(e.sortid)||e.isSpecial?c.value.indexOf(e.sortid)/8:1e3})},editFeedTitle:function(e,t,r,n){A({ac:"edit",t:t,s:e},r,n)},editFeedLabel:function(e,t,r,n,o){var s={ac:"edit",s:e};r?s.a=t:s.r=t,A(s,n,o)},getUnreadCounts:function(t,n){y({url:r+f,onSuccess:function(r){var o=JSON.parse(r.responseText).unreadcounts,s={};g(o).each(function(t){s[e.correctId(t.id)]=t.count}),e.unreadCountsObj=s,n?t(s):t(o)},onFailure:function(e){console.error(e)}})},unsubscribeFeed:function(e,t){A({ac:"unsubscribe",s:e},t)},subscribeFeed:function(e,t,r){A({ac:"subscribe",s:"feed/"+e,t:r||void 0},t)},markAllAsRead:function(e,t){y({method:"POST",url:r+c,parameters:{s:e},onSuccess:function(e){t(e.responseText)},onFailure:function(e){console.error(e)}})}},w={get:function(){return g(x.get()).select(function(e){return e.isLabel})},load:function(e){y({method:"GET",url:r+i+a,onSuccess:function(t){e(JSON.parse(t.responseText).tags)},onFailure:function(e){console.error(e)}})},editLabelTitle:function(t,n,o,s){y({method:"POST",url:r+p,parameters:{s:t,t:t,dest:e.TAGS.label+n},onSuccess:function(e){o(e.responseText)},onFailure:function(e){console.error(e),s&&s()}})}},e.feeds=x,e.labels=w,e.getItems=function(e,t,n){var s=n||{n:50};s.r=s.r||"d",y({method:"GET",url:r+o+encodeURIComponent(e),parameters:s,onSuccess:function(e){t(JSON.parse(e.responseText).items)},onFailure:function(e){console.error(e)}})},e.setItemTag=function(t,n,o,s,i,a){var u={async:"true",ac:"edit-tags"};s===!0?u.a=e.TAGS[o]:u.r=e.TAGS[o],g.isArray(n)&&g.isArray(t)?(u.set=[],g.each(n,function(e,r){u.set.push({i:e,s:t[r]})})):(u.s=t,u.i=n),y({method:"POST",url:r+m,parameters:u,onSuccess:function(e){"OK"===e.responseText&&i(e.responseText)},onFailure:function(e){console.error("FAILED",e),a&&a()}})};var E=/user\/\d*\//;e.correctId=function(e){return e.replace(E,"user/-/")};var F=/^true$/i;e.isRead=function(t){if(void 0!==t.read)return F.test(t.read);for(var r=0;t.categories.length>r;r++)if(e.correctId(t.categories[r])===e.TAGS.read)return!0;return!1},e.isStarred=function(t){if(void 0!==t.starred)return F.test(t.starred);for(var r=0;t.categories.length>r;r++)if(e.correctId(t.categories[r])===e.TAGS.star)return!0;return!1},e.getIconForFeed=function(e){return"http://www.google.com/s2/favicons?domain_url="+encodeURIComponent(e)},e.normalizeError=function(e){var t=g(e).lines()[0].replace("Error=","").replace(/(\w)([A-Z])/g,"$1 $2");return t="Bad Authentication"===t?"Incorrect Email/Password":t}}).call(this);