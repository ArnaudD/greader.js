/*! greader.js 2013-03-03 */
(function(){function e(e){this.key=e}var r,t="https://www.google.com/accounts/ClientLogin",o="http://www.google.com/reader/api/0/",n="preference/stream/list",s="stream/contents/",i="subscription/",a="tag/",c="list",u="edit",d="mark-all-as-read",l="token",f="user-info",p="unread-count",g="rename-tag",m="edit-tag",h=[],T=new e("Auth"),S=new e("User"),v="",x=[];if(r={CLIENT:"greader.js",TAGS:{like:"user/-/state/com.google/like",label:"user/-/label/",star:"user/-/state/com.google/starred",read:"user/-/state/com.google/read",fresh:"user/-/state/com.google/fresh",share:"user/-/state/com.google/broadcast","kept-unread":"user/-/state/com.google/kept-unread","reading-list":"user/-/state/com.google/reading-list"},has_loaded_prefs:!1},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=r),exports.greader=r):this.greader=r,!I&&require){var I=require("underscore");I.string=require("underscore.string")}if(!b)var b=require("xhr2");if(I.mixin(I.string.exports()),I.string.include("Underscore.string","string"),!w)var w={};e.prototype.get=function(){if(w[this.key])try{return JSON.parse(w[this.key])}catch(e){return w[this.key]}},e.prototype.set=function(e){try{w[this.key]="string"==typeof e?e:JSON.stringify(e)}catch(r){console.error("Error Saving to localStorage")}},e.prototype.del=function(){delete w[this.key]};var y,E=function(e){var r,t=[];for(r in e)e.hasOwnProperty(r)&&("set"===r?I.each(e[r],function(e){E(e)}):t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r])));return t.join("&")},F=function(e,t){4===this.readyState&&200===this.status?t.onSuccess&&(t.onSuccess(this),x[e]&&delete x[e]):4===this.readyState&&("POST"===t.method?t.tried||r.user.getToken(function(){t.tried=!0,O(t),x[e]&&delete x[e]},t.onFailure):t.onFailure&&(t.onFailure(this),x[e]&&delete x[e]),401===this.status&&"Unauthorized"===this.statusText&&console.error("AUTH EXPIRED? TRY LOGGING IN AGAIN"),console.error("Request Failed: "+this))},O=function(e,r){var t,o,n;e.method=e.method||"GET",e.parameters=e.parameters||{},"GET"===e.method&&(e.parameters.ck=Date.now()||(new Date).getTime(),e.parameters.accountType="GOOGLE",e.parameters.service="reader",e.parameters.output="json",e.parameters.client="greader.js"),v&&"POST"===e.method&&(e.parameters.T=v),n=E(e.parameters),t=e.url+"?",t+="GET"===e.method?n:"client="+encodeURIComponent(CLIENT),o=new b,o.open(e.method,t,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Cookie",""),T.get()&&!r&&o.setRequestHeader("Authorization","GoogleLogin auth="+T.get()),o.onreadystatechange=I.bind(F,o,x.length,e),o.send("POST"===e.method?n:""),x.push(o)};y={isAuth:function(){return T.get()?!0:void 0},login:function(e,o,n,s){return 0===e.length||0===o.length?(s("Blank Info..."),void 0):(O({method:"GET",url:t,parameters:{Email:e,Passwd:o},onSuccess:function(e){T.set(I.lines(e.responseText)[2].replace("Auth=","")),y.load(n,s)},onFailure:function(e){console.error(e),s(r.normalizeError(e.responseText))}}),void 0)},logout:function(){T.del(),S.del(),r.setFeeds([])},getToken:function(e,t){O({method:"GET",url:o+l,parameters:{},onSuccess:function(r){v=r.responseText,e()},onFailure:function(e){console.error("failed",e),t&&t(r.normalizeError(e.responseText))}})},load:function(e,t){O({method:"GET",url:o+f,parameters:{},onSuccess:function(r){var t=JSON.parse(r.responseText);S.set(t),e(t)},onFailure:function(e){console.error(e),t&&t(r.normalizeError(e.responseText))}})},loadPreferences:function(e,t){O({method:"GET",url:o+n,parameters:{},onSuccess:function(r){y.preferencesLoaded=!0,y.preferences=JSON.parse(r.responseText).streamprefs,e&&e()},onFailure:function(e){console.error(e),t&&t(r.normalizeError(e.responseText))}})},get:function(){return S.get()}},r.user=y;var G,A,k=function(e,r,t){return e?(O({method:"POST",url:o+i+u,parameters:e,onSuccess:function(e){r(e.responseText)},onFailure:function(e){console.error(e),t&&t(e)}}),void 0):(console.error("No params for feed edit"),void 0)};G={set:function(e){h=e},get:function(){return h},load:function(e){return r.user.preferencesLoaded?(O({method:"GET",url:o+i+c,onSuccess:function(t){A.load(function(o){G.getUnreadCounts(function(n){G.set(G.organize(JSON.parse(t.responseText).subscriptions,o,n,r.user.preferences)),e(G.get())})})},onFailure:function(e){console.error(e)}}),void 0):r.user.loadPreferences(G.load)},organize:function(e,t,o,n){var s=[],i=I(t).reject(function(e){return"user/-/state/com.google/broadcast"===r.correctId(e.id)||"user/-/state/com.blogger/blogger-following"===r.correctId(e.id)});i.unshift({title:"All",id:r.TAGS["reading-list"],feeds:e,isAll:!0,isSpecial:!0});var a=/[^\/]+$/i;I(i).each(function(e){e.title=e.title||a.exec(e.id)[0],"starred"===e.title?(e.title=I(e.title).capitalize(),e.isSpecial=!0):e.isSpecial||(e.isLabel=!0),e.feeds=[],e.id=r.correctId(e.id),I(o).each(function(t){t.id=r.correctId(t.id),e.id===t.id&&(e.count=t.count,e.newestItemTimestamp=t.newestItemTimestampUsec)})}),I(e).each(function(e){e.isFeed=!0,e.id=r.correctId(e.id),I(o).each(function(r){e.id===r.id&&(e.count=r.count,e.newestItemTimestamp=r.newestItemTimestampUsec)}),0===e.categories.length?s.push(e):I(e.categories).each(function(t){t.id=r.correctId(t.id),I(i).each(function(r){if(t.id===r.id){var o=I(e).clone();o.inside=r.id,r.feeds.push(o)}})})}),I(n).each(function(e,t){/user\/\d*\//.test(t)&&(n[r.correctId(t)]=e)});var c=I(i).reject(function(e){return 0===e.feeds.length&&!e.isSpecial});I(c).each(function(e){var r=I(n[e.id]).detect(function(e){return"subscription-ordering"===e.id});r&&(e.feeds=I(e.feeds).sortBy(function(e){return-1===r.value.indexOf(e.sortid)?1e3:r.value.indexOf(e.sortid)/8}))});var u=I(n["user/-/state/com.google/root"]).detect(function(e){return"subscription-ordering"===e.id})||{value:""},d=[].concat(c,s);return d=I(d).sortBy(function(e){return-1!==u.value.indexOf(e.sortid)||e.isSpecial?u.value.indexOf(e.sortid)/8:1e3})},editFeedTitle:function(e,r,t,o){k({ac:"edit",t:r,s:e},t,o)},editFeedLabel:function(e,r,t,o,n){var s={ac:"edit",s:e};t?s.a=r:s.r=r,k(s,o,n)},getUnreadCounts:function(e,t){O({url:o+p,onSuccess:function(o){var n=JSON.parse(o.responseText).unreadcounts,s={};I(n).each(function(e){s[r.correctId(e.id)]=e.count}),r.unreadCountsObj=s,t?e(s):e(n)},onFailure:function(e){console.error(e)}})},unsubscribeFeed:function(e,r){k({ac:"unsubscribe",s:e},r)},subscribeFeed:function(e,r,t){k({ac:"subscribe",s:"feed/"+e,t:t||void 0},r)},markAllAsRead:function(e,r){O({method:"POST",url:o+d,parameters:{s:e},onSuccess:function(e){r(e.responseText)},onFailure:function(e){console.error(e)}})}},A={get:function(){return I(G.get()).select(function(e){return e.isLabel})},load:function(e){O({method:"GET",url:o+a+c,onSuccess:function(r){e(JSON.parse(r.responseText).tags)},onFailure:function(e){console.error(e)}})},editLabelTitle:function(e,t,n,s){O({method:"POST",url:o+g,parameters:{s:e,t:e,dest:r.TAGS.label+t},onSuccess:function(e){n(e.responseText)},onFailure:function(e){console.error(e),s&&s()}})}},r.feeds=G,r.labels=A,r.getItems=function(e,r,t){var n=t||{n:50};n.r=n.r||"d",O({method:"GET",url:o+s+encodeURIComponent(e),parameters:n,onSuccess:function(e){r(JSON.parse(e.responseText).items)},onFailure:function(e){console.error(e)}})},r.setItemTag=function(e,t,n,s,i,a){var c={async:"true",ac:"edit-tags"};s===!0?c.a=r.TAGS[n]:c.r=r.TAGS[n],I.isArray(t)&&I.isArray(e)?(c.set=[],I.each(t,function(r,t){c.set.push({i:r,s:e[t]})})):(c.s=e,c.i=t),O({method:"POST",url:o+m,parameters:c,onSuccess:function(e){"OK"===e.responseText&&i(e.responseText)},onFailure:function(e){console.error("FAILED",e),a&&a()}})};var N=/user\/\d*\//;r.correctId=function(e){return e.replace(N,"user/-/")};var C=/^true$/i;r.isRead=function(e){if(void 0!==e.read)return C.test(e.read);for(var t=0;e.categories.length>t;t++)if(r.correctId(e.categories[t])===r.TAGS.read)return!0;return!1},r.isStarred=function(e){if(void 0!==e.starred)return C.test(e.starred);for(var t=0;e.categories.length>t;t++)if(r.correctId(e.categories[t])===r.TAGS.star)return!0;return!1},r.getIconForFeed=function(e){return"http://www.google.com/s2/favicons?domain_url="+encodeURIComponent(e)},r.normalizeError=function(e){var r=I(e).lines()[0].replace("Error=","").replace(/(\w)([A-Z])/g,"$1 $2");return r="Bad Authentication"===r?"Incorrect Email/Password":r}}).call(this);